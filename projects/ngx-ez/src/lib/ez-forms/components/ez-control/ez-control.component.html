<ng-container *ngIf="config$ | async as config">
  <ng-container *ngIf="name$ | async as name">
    <div class="ez-control" [ngClass]="config.controlClasses">
      <ng-container *ngTemplateOutlet="fieldset !== false ? fieldsetTemplate : labelTemplate"></ng-container>
    </div>

    <ng-template #fieldsetTemplate>
      <fieldset *ngIf="!(readonly$ | async) else readonlyTemplate" [attr.aria-describedby]="(invalid$ | async) ? name + '_validation_message' : null">
        <legend class="ez-label" [ngClass]="config.labelContainerClasses">
          <span [ngClass]="config.labelClasses">
            <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
          </span>
        </legend>
        <div class="ez-controls" [ngClass]="config.controlsContainerClasses">
          <ng-container *ngTemplateOutlet="controlsTemplate"></ng-container>
          <div tabindex="-1" [id]="name + '_validation_message'" class="ez-validation" [ngClass]="config.validationClasses" *ngIf="invalid$ | async">{{ message$ | async }}</div>
        </div>
      </fieldset>
    </ng-template>

    <ng-template #labelTemplate>
      <ng-container *ngIf="!(readonly$ | async) else readonlyTemplate">
        <label class="ez-label" [ngClass]="config.labelClasses" [id]="name + '_control_input_label'" [for]="name + '_control_input'">
          <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
        </label>
        <div class="ez-controls" [ngClass]="config.controlsContainerClasses">
          <ng-container *ngTemplateOutlet="controlsTemplate"></ng-container>
        </div>
        <div tabindex="-1" [id]="name + '_validation_message'" class="ez-validation" [ngClass]="config.validationClasses" *ngIf="invalid$ | async">{{ message$ | async }}</div>
      </ng-container>
    </ng-template>

    <ng-template #readonlyTemplate>
      <div [ngClass]="config.labelContainerClasses">
        <span class="ez-label" [ngClass]="config.readonlyLabelClasses">
          <ng-container *ngTemplateOutlet="contentTemplate"></ng-container>
        </span>
      </div>
      <div class="ez-controls" [ngClass]="config.controlsContainerClasses">
        <span class="ez-readonly" [ngClass]="config.readonlyClasses">
          <ng-container *ngTemplateOutlet="controlsTemplate"></ng-container>
        </span>
      </div>
    </ng-template>

    <ng-template #contentTemplate>
      <ng-content></ng-content>
      <span class="ez-required" *ngIf="showRequired$ | async">*</span>
    </ng-template>

    <ng-template #controlsTemplate>
      <ng-content select="[controls-container]"></ng-content>
    </ng-template>
  </ng-container>
</ng-container>
